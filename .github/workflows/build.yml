---
name: Build and Publish images to Github Container Registry
on:
  push:
    branches:
      - main
  schedule:
    - cron: '5 5 * * 5' # every Friday
  workflow_dispatch:


jobs:
  build:
    name: "ðŸ› ï¸ - Build EE"
    runs-on: arc-runner-set-forristal
    env:
      REGISTRY: ghcr.io
      TRIVY_DISABLE_VEX_NOTICE: true
    permissions:
      contents: read
      issues: write
      packages: write
    steps:
      - name: ðŸ”¢ - Set version
        run: |
          echo "VERSION=$(date +%Y.%-m.%-d)" >> ${GITHUB_ENV}
          echo "DATETIME=$(date --rfc-3339=seconds)" >> ${GITHUB_ENV}
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ§³ - Checout Repo
        uses: actions/checkout@v4

      - name: ðŸš¢ - Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ - Install python dependencies
        run: pip install -r build-requirements.txt

      - name: ðŸ·ï¸ - Add annotations
        run: |
          cat > annotations.yml << EOT
          additional_build_steps:
            append_final:
              - LABEL org.opencontainers.image.created="${{ env.DATETIME }}"
              - LABEL org.opencontainers.image.authors="${{ github.triggering_actor }}"
              - LABEL org.opencontainers.image.url="https://github.com/${{ github.repository }}"
              - LABEL org.opencontainers.image.documentation="https://github.com/${{ github.repository }}/docs/README.md"
              - LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"
              - LABEL org.opencontainers.image.description="A fluffier execution environment for ansible.  Should cover the bases for windows and linux prereqs."
          EOT
          docker run --rm -v "${PWD}":/workdir mikefarah/yq '. *= load("annotations.yml")' execution-environment.yml > execution-environment-final.yml
          mv execution-environment-final.yml execution-environment.yml

      - name: ðŸ‘ - Create fluffy container file
        run: >
          ansible-builder create -v3 

      - name: ðŸ³ - Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ - Build images
        uses: docker/build-push-action@v6
        with:
          context: context
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}:${{ env.VERSION }}
            ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ github.repository }}:unstable
            ${{ env.REGISTRY }}/${{ github.repository }}:latest
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}:cache
          cache-to: type=registry,mode=max,ref=${{ env.REGISTRY }}/${{ github.repository }}:cache
          outputs: type=docker,dest=/tmp/image.tar
      
      - name: ðŸšš - Stash container for testing
        uses: actions/upload-artifact@v4
        with:
          retention-days: 7
          name: image-${{ github.sha }}
          path: /tmp/image.tar

  test:
    name: "ðŸ§ª - Test EE"
    runs-on: arc-runner-set-forristal
    needs: ['build']
    env:
      REGISTRY: ghcr.io
      TRIVY_DISABLE_VEX_NOTICE: true
    permissions:
      security-events: write
      contents: read
      packages: read
      issues: write
      attestations: write
    steps:
      - name: ðŸ³ - Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: image-${{ github.sha }}
          path: /tmp/

      - name: Load Docker image
        run: |
          docker load --input /tmp/image.tar

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }}
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Generate Summary
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }}
          severity: 'CRITICAL,HIGH'
          format: 'table'
          output: trivy-summary.txt 
          
      - name: Append Summary
        run: |  
          {  
            echo "### Scan Summary" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Click to expand</summary>"
            cat trivy-summary.txt 
            echo "</details>"
          } >> $GITHUB_STEP_SUMMARY


  push:
    name: "ðŸš¢ - Push EE"
    runs-on: arc-runner-set-forristal
    needs: ['build','test']
    env:
      REGISTRY: ghcr.io
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ³ - Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: image-${{ github.sha }}
          path: /tmp/

      - name: Load Docker image
        run: |
          docker load --input /tmp/image.tar
      
      - name: ðŸš¢ - Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸš¢ - Push Image to registry
        run: >
          docker push --all-tags ${{ env.REGISTRY }}/${{ github.repository }}
          
      # - name:  Create a Release
      #   uses: elgohr/Github-Release-Action@v5
      #   env:
      #     GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     title: "Unstable Release: ${{ env.VERSION }}"
      #     prerelease: true
      #     tag: ${{ env.VERSION }}
