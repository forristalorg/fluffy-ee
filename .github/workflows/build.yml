---
name: Build, Test, and Publish images to Github Container Registry
on:
  pull_request:
    paths-ignore:
      - ".**"
      - "docs/**"
      - "**.md"
      - ".gitignore"
      - "LICENSE"
      - "!.github/workflows/build.yml"
    branches:
      - main
  push:
    paths-ignore:
      - ".**"
      - "docs/**"
      - "**.md"
      - ".gitignore"
      - "LICENSE"
      - "!.github/workflows/build.yml"
    branches:
      - main
  schedule:
    - cron: "0 2 * * 5" # every Friday
  workflow_dispatch:
    inputs:
      push:
        type: boolean
        description: "Push image after building?"
        default: false
env:
  REGISTRY: ghcr.io
  TRIVY_DISABLE_VEX_NOTICE: true

jobs:
  build:
    name: "ðŸ› ï¸ - Build EE"
    runs-on: arc-runner-set-forristal
    permissions:
      contents: read
      issues: write
      packages: write
    outputs:
      VERSION: ${{ steps.setver.outputs.VERSION }}
    steps:
      - name: ðŸ›’ - Checout Repo
        uses: actions/checkout@v4

      - name: ðŸ“‚ - Cache maintenance
        run: |
          mkdir -p /var/_cache/${{ github.repository }}
          find /var/_cache/${{ github.repository }} -mtime +30 -delete

      - name: "ðŸ§° - Download gh cli packages"
        run: |
          mkdir -p packages
          ASSETS=$(curl -fsSL https://api.github.com/repos/cli/cli/releases/latest | jq -r '.assets')
          curl -fsSL $(echo $ASSETS | jq -r '.[] | select(.browser_download_url | contains("amd64.rpm")) | .browser_download_url ') -o packages/gh.rpm
          curl -fsSL $(echo $ASSETS | jq -r '.[] | select(.browser_download_url | contains("amd64.deb")) | .browser_download_url ') -o packages/gh.deb 
          ls -la packages
          echo $ASSETS | jq -r '.[0].label'
      - name: ðŸ”¢ - Set version
        id: setver
        run: |
          echo "VERSION=$(date +%Y.%-m.%-d)" | tee -a ${GITHUB_ENV} ${GITHUB_OUTPUT}
          echo "DATETIME=$(date --rfc-3339=seconds)" | tee -a ${GITHUB_ENV}

      - name: ðŸ - Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: ðŸš¢ - Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ¥š - Install python dependencies
        run: pip install -r build-requirements.txt

      - name: ðŸ·ï¸ - Add annotations
        run: |
          cat > annotations.yml << EOT
          additional_build_steps:
            append_final:
              - LABEL org.opencontainers.image.version="${{ env.VERSION }}"
              - LABEL org.opencontainers.image.revision="${{ github.sha }}"
              - LABEL org.opencontainers.image.created="${{ env.DATETIME }}"
              - LABEL org.opencontainers.image.authors="${{ github.triggering_actor }}"
              - LABEL org.opencontainers.image.url="https://github.com/${{ github.repository }}"
              - LABEL org.opencontainers.image.documentation="https://github.com/${{ github.repository }}/docs/README.md"
              - LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"
              - LABEL org.opencontainers.image.description="A fluffier execution environment for ansible.  Should cover the bases for windows and linux prereqs."
          EOT
          docker run --rm -v "${PWD}":/workdir mikefarah/yq '. *= load("annotations.yml")' execution-environment.yml > execution-environment-final.yml
          mv execution-environment-final.yml execution-environment.yml

      - name: ðŸ‘ - Create fluffy container file
        run: >
          ansible-builder create -v3

      - name: ðŸ³ - Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ - Build images
        env:
          RB_ACCESS: ${{ vars.RUSTBUCKET_S3_ACCESS_KEY }}
          RB_SECRET: ${{ secrets.RUSTBUCKET_S3_SECRET_KEY }}
          RB_URL: "https://${{ vars.RUSTBUCKET_S3_HOST }}/cache"
        uses: docker/build-push-action@v6
        with:
          context: context
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository }}:${{ env.VERSION }}
            ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ github.repository }}:unstable
            ${{ env.REGISTRY }}/${{ github.repository }}:latest
          cache-from: |
            type=local,src=/var/_cache/${{ github.repository }}
            type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}:cache
            type=registry,ref=${{ env.REGISTRY }}/${{ github.repository }}:latest
          # type=s3,bucket=cache,region=us-east-1,endpoint_url=${{ env.RB_URL }},access_key_id=${{ env.RB_ACCESS }},secret_access_key=${{ env.RB_SECRET }}
          cache-to: |
            type=local,dest=/var/_cache/${{ github.repository }}
            type=registry,mode=max,ref=${{ env.REGISTRY }}/${{ github.repository }}:cache
          # type=s3,bucket=cache,region=us-east-1,endpoint_url=${{ env.RB_URL }},access_key_id=${{ env.RB_ACCESS }},secret_access_key=${{ env.RB_SECRET }}
          outputs: type=docker,dest=/var/_cache/${{ github.repository }}.tar    


      # - name: ðŸšš - Stash container for testing
      #   uses: actions/upload-artifact@v4
      #   with:
      #     retention-days: 1
      #     name: image-${{ github.sha }}
      #     path: /tmp/image.tar

  test:
    name: "ðŸ§ª - Test EE"
    runs-on: arc-runner-set-forristal
    needs: ["build"]
    permissions:
      security-events: write
      contents: read
      packages: read
      issues: write
      attestations: write
    steps:
      - name: ðŸ›’ - Checkout Repo
        uses: actions/checkout@v4

      - name: ðŸ³ - Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Trivy
        uses: aquasecurity/setup-trivy@v0.2.4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Download artifact
      #   uses: actions/download-artifact@v5
      #   with:
      #     name: image-${{ github.sha }}
      #     path: /tmp/

      - name: Load Docker image
        run: |
          docker load --input /var/_cache/${{ github.repository }}.tar

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          skip-setup-trivy: true
          image-ref: ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.sha }}
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-results.sarif"

      - name: Generate Markdown report
        if: always()
        uses: b-zurg/sarif-to-markdown@v1
        with:
          file-path: "trivy-results.sarif"
          add-job-summary: true

  push:
    name: "ðŸš¢ - Push EE"
    if: ${{ github.event_name == 'push' && github.ref_protected || (github.event_name =='workflow_dispatch' && inputs.push) }}
    runs-on: arc-runner-set-forristal
    needs: ["build", "test"]
    permissions:
      contents: read
      packages: write
    steps:
      - name: ðŸ³ - Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # - name: Download artifact
      #   uses: actions/download-artifact@v5
      #   with:
      #     name: image-${{ github.sha }}
      #     path: /tmp/

      - name: Load Docker image
        run: |
          docker load --input /var/_cache/${{ github.repository }}.tar

      - name: ðŸš¢ - Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸš¢ - Push Image to registry
        run: >
          docker push --all-tags ${{ env.REGISTRY }}/${{ github.repository }}
